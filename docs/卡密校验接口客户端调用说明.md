# å¡å¯†æ ¡éªŒæ¥å£å®¢æˆ·ç«¯è°ƒç”¨è¯´æ˜

## ğŸ“‹ æ¥å£ä¿¡æ¯

### æ–°æ¥å£

- **åœ°å€**: `https://env-00jxu65bfie3.dev-hz.cloudbasefunction.cn/http/router/admin/card/pub/verify`
- **è¯·æ±‚å‚æ•°**: `{ key, product_id, id, machineCode }`
- **æˆåŠŸå“åº”**: `{ code: 0, msg: '...', data: {...} }`
- **å¤±è´¥å“åº”**: `{ code: -1, msg: '...' }`
- **è¯·æ±‚æ–¹å¼**: `POST`


## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

ç»Ÿä¸€æ¥å£è‡ªåŠ¨å¤„ç†ï¼š

- âœ… **å¡å¯†æ¿€æ´»**ï¼šé¦–æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨æ¿€æ´»å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´
- âœ… **æœºå™¨ç»‘å®š**ï¼šè‡ªåŠ¨ç»‘å®šæ–°æœºå™¨ï¼Œæ£€æŸ¥æœºå™¨æ•°é‡é™åˆ¶
- âœ… **çŠ¶æ€æ ¡éªŒ**ï¼šéªŒè¯å¡å¯†æ˜¯å¦è¿‡æœŸã€æ¬¡æ•°æ˜¯å¦ç”¨å®Œ

## ğŸ“ è¯·æ±‚å‚æ•°

```javascript
{
  key: "ABCD-1234-EFGH-5678",      // å¡å¯†ç ï¼ˆå¿…å¡«ï¼‰
  product_id: "product_001",       // äº§å“IDï¼ˆå¿…å¡«ï¼‰
  machineCode: "machine-001",      // æœºå™¨ç ï¼ˆå¯é€‰ï¼Œå–å†³äºå¡å¯†æ˜¯å¦é™åˆ¶æœºå™¨æ•°é‡ï¼‰
  id: "user123"                    // ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
}
```

### å‚æ•°è¯´æ˜

| å‚æ•°        | ç±»å‹   | å¿…å¡« | è¯´æ˜                                                 |
| ----------- | ------ | ---- | ---------------------------------------------------- |
| key         | String | æ˜¯   | å¡å¯†ç                                                |
| product_id  | String | æ˜¯   | äº§å“IDï¼ˆå¡å¯†æ‰€å±äº§å“ï¼‰                               |
| machineCode | String | å¦   | æœºå™¨ç ï¼ˆè®¾å¤‡å”¯ä¸€æ ‡è¯†ï¼‰ã€‚å¦‚æœå¡å¯†é™åˆ¶æœºå™¨æ•°é‡ï¼Œåˆ™å¿…å¡« |
| id          | String | æ˜¯   | ç”¨æˆ·IDï¼ˆè´­ä¹°å¡å¯†çš„ç”¨æˆ·IDï¼‰                           |

## ğŸ“¤ å“åº”ç»“æœ

### æˆåŠŸå“åº”ï¼ˆcode: 0ï¼‰

```javascript
{
  code: 0,
  msg: "å¡å¯†æ¿€æ´»æˆåŠŸï¼Œæœºå™¨ç»‘å®šæˆåŠŸ",  // æˆ– "æœºå™¨ç»‘å®šæˆåŠŸ" æˆ– "æ ¡éªŒæˆåŠŸ"
  data: {
    // åŸºæœ¬ä¿¡æ¯
    card_id: "card_id_123",
    card_code: "ABCD-1234-EFGH-5678",
    card_type: "monthly",
    product_id: "product_001",
    product_name: "äº§å“åç§°",

    // æ¿€æ´»å’Œç»‘å®šçŠ¶æ€
    is_activated: true,        // æ˜¯å¦æœ¬æ¬¡æ¿€æ´»
    is_new_machine: true,      // æ˜¯å¦æ–°ç»‘å®šæœºå™¨

    // æ—¶é—´ä¿¡æ¯
    has_time_limit: true,      // æ˜¯å¦æœ‰é™åˆ¶å¤©æ•°
    limit_days: 30,            // é™åˆ¶å¤©æ•°ï¼ˆ-1è¡¨ç¤ºä¸é™ï¼‰
    activate_time: 1730678400000,           // æ¿€æ´»æ—¶é—´æˆ³
    expire_time: 1733270400000,             // è¿‡æœŸæ—¶é—´æˆ³
    activate_time_text: "2025-11-04 10:00:00",  // æ¿€æ´»æ—¶é—´æ–‡æœ¬
    expire_time_text: "2025-12-04 10:00:00",    // è¿‡æœŸæ—¶é—´æ–‡æœ¬ï¼ˆæ°¸ä¹…æœ‰æ•ˆæ—¶æ˜¾ç¤º"æ°¸ä¹…æœ‰æ•ˆ"ï¼‰

    // æ¬¡æ•°ä¿¡æ¯
    has_times_limit: false,    // æ˜¯å¦æœ‰é™åˆ¶æ¬¡æ•°
    total_times: -1,           // æ€»æ¬¡æ•°ï¼ˆ-1è¡¨ç¤ºä¸é™ï¼‰
    used_times: 0,             // å·²ä½¿ç”¨æ¬¡æ•°
    remaining_times: -1,       // å‰©ä½™æ¬¡æ•°ï¼ˆ-1è¡¨ç¤ºä¸é™ï¼‰

    // æœºå™¨ç ä¿¡æ¯
    has_machine_limit: true,   // æ˜¯å¦æœ‰é™åˆ¶æœºå™¨æ•°é‡
    max_machine_count: 5,      // æœ€å¤§æœºå™¨æ•°ï¼ˆ-1è¡¨ç¤ºä¸é™ï¼‰
    current_machine_count: 1,  // å½“å‰å·²ç»‘å®šæœºå™¨æ•°
    authorized_machines: [     // å·²æˆæƒæœºå™¨ç åˆ—è¡¨
      "machine-001"
    ]
  }
}
```

### å¤±è´¥å“åº”ï¼ˆcode: -1ï¼‰

```javascript
{
  code: -1,
  msg: "é”™è¯¯ä¿¡æ¯"
}
```

### å¸¸è§é”™è¯¯ä¿¡æ¯

- `"è¯·è¾“å…¥å¯†é’¥"` - æœªæä¾›å¡å¯†ç 
- `"è¯·ä¼ å…¥ç”¨æˆ·IDå‚æ•°ï¼ˆidï¼‰"` - æœªæä¾›ç”¨æˆ·ID
- `"å¡å¯†ä¸å­˜åœ¨æˆ–ä¸å±äºè¯¥äº§å“"` - å¡å¯†ç é”™è¯¯ã€äº§å“IDä¸åŒ¹é…æˆ–ä¸å­˜åœ¨
- `"æ­¤å¡å¯†ä¸å±äºæ‚¨ï¼Œæ— æ³•ä½¿ç”¨"` - ç”¨æˆ·IDä¸å¡å¯†è´­ä¹°è€…ä¸åŒ¹é…
- `"å¡å¯†å·²è¿‡æœŸ"` - å¡å¯†å·²è¶…è¿‡æœ‰æ•ˆæœŸ
- `"ä½¿ç”¨æ¬¡æ•°å·²ç”¨å®Œ"` - å¡å¯†ä½¿ç”¨æ¬¡æ•°å·²ç”¨å®Œ
- `"æ­¤å¡å¯†éœ€è¦æä¾›æœºå™¨ç "` - å¡å¯†é™åˆ¶æœºå™¨æ•°é‡ä½†æœªæä¾›æœºå™¨ç 
- `"å·²è¾¾åˆ°æœ€å¤§æˆæƒæœºå™¨æ•°é‡"` - å¡å¯†å·²ç»‘å®šæœ€å¤§æ•°é‡çš„æœºå™¨

## ğŸ”„ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šé¦–æ¬¡æ¿€æ´»ï¼ˆæœªä½¿ç”¨çš„å¡å¯†ï¼‰

**è¯·æ±‚ï¼š**

```javascript
{
  key: "ABCD-1234-EFGH-5678",
  product_id: "product_001",
  machineCode: "machine-001",
  id: "user123"
}
```

**å“åº”ï¼š**

- `is_activated: true` - æœ¬æ¬¡æ¿€æ´»
- `is_new_machine: true` - æ–°ç»‘å®šæœºå™¨
- `activate_time` - è®¾ç½®ä¸ºå½“å‰æ—¶é—´
- `expire_time` - è‡ªåŠ¨è®¡ç®—ï¼ˆæ¿€æ´»æ—¶é—´ + é™åˆ¶å¤©æ•°ï¼‰

### åœºæ™¯2ï¼šç»‘å®šæ–°æœºå™¨ï¼ˆå·²æ¿€æ´»çš„å¡å¯†ï¼‰

**è¯·æ±‚ï¼š**

```javascript
{
  key: "ABCD-1234-EFGH-5678",
  product_id: "product_001",
  machineCode: "machine-002",  // æ–°æœºå™¨
  id: "user123"
}
```

**å“åº”ï¼š**

- `is_activated: false` - éæœ¬æ¬¡æ¿€æ´»
- `is_new_machine: true` - æ–°ç»‘å®šæœºå™¨
- `authorized_machines` - åŒ…å«æ–°æœºå™¨ç 

### åœºæ™¯3ï¼šå®šæœŸæ ¡éªŒï¼ˆå·²ç»‘å®šçš„æœºå™¨ï¼‰

**è¯·æ±‚ï¼š**

```javascript
{
  key: "ABCD-1234-EFGH-5678",
  product_id: "product_001",
  machineCode: "machine-001",  // å·²ç»‘å®šçš„æœºå™¨
  id: "user123"
}
```

**å“åº”ï¼š**

- `is_activated: false` - éæœ¬æ¬¡æ¿€æ´»
- `is_new_machine: false` - éæ–°ç»‘å®šæœºå™¨
- `msg: "æ ¡éªŒæˆåŠŸ"`

### åœºæ™¯4ï¼šè¶…å‡ºæœºå™¨æ•°é‡é™åˆ¶

**è¯·æ±‚ï¼š**

```javascript
{
  key: "ABCD-1234-EFGH-5678",
  product_id: "product_001",
  machineCode: "machine-011",  // ç¬¬11å°æœºå™¨ï¼ˆå¡å¯†é™åˆ¶10å°ï¼‰
  id: "user123"
}
```

**å“åº”ï¼š**

```javascript
{
  code: -1,
  msg: "å·²è¾¾åˆ°æœ€å¤§æˆæƒæœºå™¨æ•°é‡"
}
```

## ğŸ’» å®¢æˆ·ç«¯é›†æˆç¤ºä¾‹

### JavaScript/Node.js

```javascript
/**
 * å¡å¯†æ ¡éªŒå‡½æ•°
 * @param {String} cardCode å¡å¯†ç 
 * @param {String} productId äº§å“ID
 * @param {String} machineCode æœºå™¨ç 
 * @param {String} userId ç”¨æˆ·ID
 * @returns {Promise<Object>} æ ¡éªŒç»“æœ
 */
async function verifyCard(cardCode, productId, machineCode, userId) {
  try {
    const response = await uniCloud.callFunction({
      name: 'router',
      data: {
        $url: 'admin/card/pub/verify',
        key: cardCode,
        product_id: productId,
        machineCode: machineCode,
        id: userId
      }
    })

    if (response.result.code === 0) {
      const data = response.result.data

      // æ¿€æ´»æˆåŠŸ
      if (data.is_activated) {
        console.log('å¡å¯†æ¿€æ´»æˆåŠŸï¼')
        console.log('æ¿€æ´»æ—¶é—´ï¼š', data.activate_time_text)
        console.log('è¿‡æœŸæ—¶é—´ï¼š', data.expire_time_text)
      }

      // æ–°æœºå™¨ç»‘å®š
      if (data.is_new_machine) {
        console.log('æœºå™¨ç»‘å®šæˆåŠŸï¼')
        console.log('å½“å‰å·²ç»‘å®šæœºå™¨æ•°ï¼š', data.current_machine_count, '/', data.max_machine_count)
      }

      // æ£€æŸ¥æ˜¯å¦å¿«è¿‡æœŸ
      if (data.has_time_limit && data.expire_time > 0) {
        const daysLeft = Math.ceil((data.expire_time - Date.now()) / (24 * 60 * 60 * 1000))
        if (daysLeft <= 7) {
          console.warn(`å¡å¯†å°†åœ¨ ${daysLeft} å¤©åè¿‡æœŸï¼Œè¯·åŠæ—¶ç»­è´¹`)
        }
      }

      return { success: true, data }
    } else {
      console.error('æ ¡éªŒå¤±è´¥ï¼š', response.result.msg)
      return { success: false, error: response.result.msg }
    }
  } catch (error) {
    console.error('è¯·æ±‚å¤±è´¥ï¼š', error)
    return { success: false, error: error.message }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const result = await verifyCard('ABCD-1234-EFGH-5678', 'product_001', 'my-machine-001', 'user123')
if (result.success) {
  console.log('æˆæƒéªŒè¯é€šè¿‡')
} else {
  console.log('æˆæƒéªŒè¯å¤±è´¥ï¼š', result.error)
}
```

### Python

```python
import requests
import json
from datetime import datetime

def verify_card(card_code, product_id, machine_code, user_id):
    """
    å¡å¯†æ ¡éªŒ
    :param card_code: å¡å¯†ç 
    :param product_id: äº§å“ID
    :param machine_code: æœºå™¨ç 
    :param user_id: ç”¨æˆ·ID
    :return: (success: bool, data: dict)
    """
    url = "https://your-domain.com/admin/card/pub/verify"

    payload = {
        "key": card_code,
        "product_id": product_id,
        "machineCode": machine_code,
        "id": user_id
    }

    try:
        response = requests.post(url, json=payload)
        result = response.json()

        if result['code'] == 0:
            data = result['data']

            if data['is_activated']:
                print('å¡å¯†æ¿€æ´»æˆåŠŸï¼')
                print(f"æ¿€æ´»æ—¶é—´ï¼š{data['activate_time_text']}")
                print(f"è¿‡æœŸæ—¶é—´ï¼š{data['expire_time_text']}")

            if data['is_new_machine']:
                print('æœºå™¨ç»‘å®šæˆåŠŸï¼')
                print(f"å½“å‰å·²ç»‘å®šï¼š{data['current_machine_count']}/{data['max_machine_count']} å°æœºå™¨")

            # æ£€æŸ¥æ˜¯å¦å¿«è¿‡æœŸ
            if data['has_time_limit'] and data['expire_time'] > 0:
                days_left = (data['expire_time'] - int(datetime.now().timestamp() * 1000)) // (24 * 60 * 60 * 1000)
                if days_left <= 7:
                    print(f"è­¦å‘Šï¼šå¡å¯†å°†åœ¨ {days_left} å¤©åè¿‡æœŸï¼Œè¯·åŠæ—¶ç»­è´¹")

            return True, data
        else:
            print(f"æ ¡éªŒå¤±è´¥ï¼š{result['msg']}")
            return False, result['msg']

    except Exception as e:
        print(f"è¯·æ±‚å¤±è´¥ï¼š{e}")
        return False, str(e)

# ä½¿ç”¨ç¤ºä¾‹
success, data = verify_card('ABCD-1234-EFGH-5678', 'product_001', 'my-machine-001', 'user123')
if success:
    print('æˆæƒéªŒè¯é€šè¿‡')
else:
    print(f'æˆæƒéªŒè¯å¤±è´¥ï¼š{data}')
```

### C# / .NET

```csharp
using System;
using System.Net.Http;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;

public class CardVerifyService
{
    private readonly HttpClient _httpClient;
    private readonly string _baseUrl;

    public CardVerifyService(string baseUrl)
    {
        _baseUrl = baseUrl;
        _httpClient = new HttpClient();
    }

    public async Task<(bool Success, dynamic Data, string Error)> VerifyCardAsync(
        string cardCode,
        string productId,
        string machineCode,
        string userId)
    {
        try
        {
            var payload = new
            {
                key = cardCode,
                product_id = productId,
                machineCode = machineCode,
                id = userId
            };

            var json = JsonSerializer.Serialize(payload);
            var content = new StringContent(json, Encoding.UTF8, "application/json");

            var response = await _httpClient.PostAsync($"{_baseUrl}/admin/card/pub/verify", content);
            var responseText = await response.Content.ReadAsStringAsync();
            var result = JsonSerializer.Deserialize<JsonElement>(responseText);

            if (result.GetProperty("code").GetInt32() == 0)
            {
                var data = result.GetProperty("data");

                if (data.GetProperty("is_activated").GetBoolean())
                {
                    Console.WriteLine("å¡å¯†æ¿€æ´»æˆåŠŸï¼");
                }

                if (data.GetProperty("is_new_machine").GetBoolean())
                {
                    Console.WriteLine("æœºå™¨ç»‘å®šæˆåŠŸï¼");
                }

                return (true, data, null);
            }
            else
            {
                var errorMsg = result.GetProperty("msg").GetString();
                Console.WriteLine($"æ ¡éªŒå¤±è´¥ï¼š{errorMsg}");
                return (false, null, errorMsg);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"è¯·æ±‚å¤±è´¥ï¼š{ex.Message}");
            return (false, null, ex.Message);
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
var service = new CardVerifyService("https://your-domain.com");
var (success, data, error) = await service.VerifyCardAsync(
    "ABCD-1234-EFGH-5678",
    "product_001",
    "my-machine-001",
    "user123"
);

if (success)
{
    Console.WriteLine("æˆæƒéªŒè¯é€šè¿‡");
}
else
{
    Console.WriteLine($"æˆæƒéªŒè¯å¤±è´¥ï¼š{error}");
}
```

## ğŸ” å®‰å…¨å»ºè®®

### 1. æœºå™¨ç ç”Ÿæˆ

æ¨èä½¿ç”¨ä»¥ä¸‹ä¿¡æ¯ç»„åˆç”Ÿæˆå”¯ä¸€æœºå™¨ç ï¼š

- **Windows**:
  ```bash
  wmic bios get serialnumber
  wmic csproduct get uuid
  ```
- **Mac/Linux**:
  ```bash
  system_profiler SPHardwareDataType | grep "Serial Number"
  cat /sys/class/dmi/id/product_uuid
  ```
- **ç»„åˆæ–¹å¼**: `MACåœ°å€ + CPUåºåˆ—å· + ä¸»æ¿åºåˆ—å·` çš„å“ˆå¸Œå€¼

### 2. æ ¡éªŒé¢‘ç‡

å»ºè®®å®¢æˆ·ç«¯è½¯ä»¶ï¼š

- **å¯åŠ¨æ—¶**ï¼šç«‹å³æ ¡éªŒ
- **è¿è¡Œä¸­**ï¼šæ¯1-2å°æ—¶æ ¡éªŒä¸€æ¬¡
- **ç½‘ç»œæ¢å¤å**ï¼šç«‹å³æ ¡éªŒ

### 3. ç¦»çº¿å®¹é”™

å»ºè®®å®ç°ç¦»çº¿ç¼“å­˜æœºåˆ¶ï¼š

- æ ¡éªŒæˆåŠŸåç¼“å­˜æˆæƒä¿¡æ¯
- ç½‘ç»œæ–­å¼€æ—¶ä½¿ç”¨ç¼“å­˜ï¼ˆè®¾ç½®æœ‰æ•ˆæœŸï¼Œå¦‚24å°æ—¶ï¼‰
- è¶…è¿‡ç¦»çº¿å®¹é”™æœŸåå¼ºåˆ¶åœ¨çº¿æ ¡éªŒ

## ğŸ“Š å­—æ®µè¯´æ˜

### æ—¶é—´å­—æ®µ

- `limit_days: -1` è¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ
- `activate_time: 0` è¡¨ç¤ºæœªæ¿€æ´»
- `expire_time: 0` è¡¨ç¤ºæœªè®¾ç½®ï¼ˆæœªæ¿€æ´»æ—¶ï¼‰

### æ¬¡æ•°å­—æ®µ

- `total_times: -1` è¡¨ç¤ºä¸é™æ¬¡æ•°
- `remaining_times: -1` è¡¨ç¤ºä¸é™æ¬¡æ•°
- `remaining_times: 0` è¡¨ç¤ºæ¬¡æ•°å·²ç”¨å®Œ

### æœºå™¨ç å­—æ®µ

- `max_machine_count: -1` è¡¨ç¤ºä¸é™æœºå™¨æ•°é‡
- `authorized_machines: []` è¡¨ç¤ºæœªç»‘å®šä»»ä½•æœºå™¨
- æ–°æœºå™¨ç ä¼šè‡ªåŠ¨æ·»åŠ åˆ° `authorized_machines` æ•°ç»„ä¸­

## âœ… æ¥å£ç‰¹ç‚¹

1. **ä¸‰åˆä¸€è®¾è®¡**ï¼šæ¿€æ´»ã€ç»‘å®šã€æ ¡éªŒç»Ÿä¸€å¤„ç†ï¼Œç®€åŒ–é›†æˆ
2. **è‡ªåŠ¨çŠ¶æ€æ›´æ–°**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶æ›´æ–°è¿‡æœŸçŠ¶æ€
3. **æœºå™¨æ•°é‡ç®¡ç†**ï¼šè‡ªåŠ¨é™åˆ¶æœºå™¨ç»‘å®šæ•°é‡
4. **å®Œæ•´è¿”å›ä¿¡æ¯**ï¼šè¿”å›è¯¦ç»†çš„æˆæƒä¿¡æ¯ä¾›å®¢æˆ·ç«¯ä½¿ç”¨
5. **æ— éœ€ç™»å½•**ï¼šå…¬å¼€æ¥å£ï¼Œæ–¹ä¾¿å®¢æˆ·ç«¯è°ƒç”¨

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç”¨æˆ·IDéªŒè¯**ï¼šç¡®ä¿ä¼ å…¥çš„ `id` å‚æ•°ä¸å¡å¯†çš„è´­ä¹°è€…IDä¸€è‡´
2. **æœºå™¨ç ä¸€è‡´æ€§**ï¼šç¡®ä¿åŒä¸€å°è®¾å¤‡æ¯æ¬¡ç”Ÿæˆçš„æœºå™¨ç ä¿æŒä¸€è‡´
3. **è¿‡æœŸæ£€æµ‹**ï¼šæ¥å£ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶æ›´æ–°è¿‡æœŸçŠ¶æ€ï¼Œå·²è¿‡æœŸçš„å¡å¯†æ— æ³•å†ä½¿ç”¨
4. **æœºå™¨æ•°é‡é™åˆ¶**ï¼šè¶…å‡ºé™åˆ¶åæ— æ³•ç»‘å®šæ–°æœºå™¨ï¼Œå¯ä»¥é€šè¿‡ç®¡ç†åå°æŸ¥çœ‹å·²ç»‘å®šæœºå™¨åˆ—è¡¨

---

**æœ€åæ›´æ–°ï¼š** 2025-01-XX  
**æ¥å£ç‰ˆæœ¬ï¼š** v2.0ï¼ˆæ–°æ¶æ„ - ä¸‹åˆ’çº¿å‘½åé£æ ¼ï¼‰
